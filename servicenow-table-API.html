<!--
//
//     Copyright (C) 2021    Daniel MartÃ­nez
//
//     This program is free software: you can redistribute it and/or modify
//     it under the terms of the GNU General Public License as published by
//     the Free Software Foundation, either version 3 of the License, or
//     (at your option) any later version.
//
//     This program is distributed in the hope that it will be useful,
//     but WITHOUT ANY WARRANTY; without even the implied warranty of
//     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
//     GNU General Public License for more details.
//
//     You should have received a copy of the GNU General Public License
//     along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->

<!-- ****************************** Configuration Node ****************************** -->
<script type="text/javascript">
    RED.nodes.registerType('servicenow-config',{
        category: 'config',
        defaults: {
            name: {value:"Instance name",required:true},
            instance: {value:"https://xxxxx.service-now.com",required:true},
            client_id: {type: "text"},
            client_secret: {type: "password"},
            scope: {value:"useraccount",required:true}
        },
        label: function() {
            return this.name;
        }
    });
</script>

<script type="text/html" data-template-name="servicenow-config">
  <div class="form-row">
    <label for="node-config-input-name"><i class="icon-tag"></i> Name</label>
    <input type="text" id="node-config-input-name" placeholder="Name">
  </div>
  <div class="form-row">
    <label for="node-config-input-instance"><i class="icon-white-globe"></i>Instance</label>
    <input type="text" id="node-config-input-instance" placeholder="https://****.service-now.com/">
  </div>
  <div class="form-row">
    <label for="node-config-input-client_id"><i class="icon-tag"></i> Client ID</label>
    <input type="text" id="node-config-input-client_id" placeholder="">
  </div>
  <div class="form-row">
    <label for="node-config-input-client_secret"><i class="icon-tag"></i> Client Secret</label>
    <input type="password" id="node-config-input-client_secret" placeholder="">
  </div>
  <div class="form-row">
    <label for="node-config-input-scope"><i class="icon-tag"></i> Scope</label>
    <input type="text" id="node-config-input-scope" placeholder="useraccount">
  </div>
</script>




<!-- ****************************** Create Record Node ****************************** -->

<script type="text/javascript">
  RED.nodes.registerType('create record', {
    category: 'Service Now Table API',
    color: '#8fc1ba',
    defaults: {
      name: {
        value: ""
      },
      server: {
        value: "",
        type: "servicenow-config"
      }
    },
    inputs: 1,
    outputs: 1,
    icon: "nodered-contrib-servicenow-icon.png",
    label: function() {
      return this.name || "create record";
    }
  });
</script>
  <script type="text/x-red" data-template-name="create record">
  <div class="form-row">
    <label for="node-input-name"><i class="icon-tag"></i> Name</label> 
    <input type="text" id="node-input-name" placeholder="Name">
  </div>
  <div class="form-row">
    <label for="node-input-server"><i class="icon-db"></i> Server</label>
    <input type="text" id="node-input-server" placeholder="server">
  </div>
</script>

<script type="text/x-red" data-help-name="create">

    <ul>
      <li><code>msg.topic</code> TableName (mandatory)</li>
      <li><code>msg.payload</code> must contain the request Body (mandatory)</li>
      <li><code>msg.sysparm_display_value</code> Return field display values (true), actual values (false), or both (all) (default: false) (optional)</li>
       <li><code>msg.sysparm_display_value</code> True to exclude Table API links for reference fields (default: false) (optional)</li>
       <li><code>msg.sysparm_exclude_reference_link</code> Return field display values (true), actual values (false), or both (all) (default: false) (optional)</li>
       <li><code>msg.sysparm_fields</code> A comma-separated list of fields to return in the response (optional)</li>
       <li><code>msg.sysparm_input_display_value</code> Set field values using their display value (true) or actual value (false) (default: false) (optional)</li>>
       <li><code>msg.sysparm_suppress_auto_sys_field</code> True to suppress auto generation of system fields (default: false) (optional)</li>
       <li><code>msg.sysparm_view</code> Render the response according to the specified UI view (overridden by sysparm_fields) (optional)</li>
    </ul>
  </p>
</script>


<!-- ****************************** Retrieve a Record Node ****************************** -->

<script type="text/javascript">
  RED.nodes.registerType('retrieve record', {
    category: 'Service Now Table API',
    color: '#8fc1ba',
    defaults: {
      name: {
        value: ""
      },
      server: {
        value: "",
        type: "servicenow-config"
      }
    },
    inputs: 1,
    outputs: 1,
    icon: "nodered-contrib-servicenow-icon.png",
    label: function() {
      return this.name || "retrieve record";
    }
  });
</script>
  <script type="text/x-red" data-template-name="retrieve record">
  <div class="form-row">
    <label for="node-input-name"><i class="icon-tag"></i> Name</label> 
    <input type="text" id="node-input-name" placeholder="Name">
  </div>
  <div class="form-row">
    <label for="node-input-server"><i class="icon-db"></i> Server</label>
    <input type="text" id="node-input-server" placeholder="server">
  </div>
</script>

<!-- ****************************** Retrieve Records Node ****************************** -->

<script type="text/javascript">
  RED.nodes.registerType('retrieve records', {
    category: 'Service Now Table API',
    color: '#8fc1ba',
    defaults: {
      name: {
        value: ""
      },
      server: {
        value: "",
        type: "servicenow-config"
      }
    },
    inputs: 1,
    outputs: 1,
    icon: "nodered-contrib-servicenow-icon.png",
    label: function() {
      return this.name || "retrieve records";
    }
  });
</script>
  <script type="text/x-red" data-template-name="retrieve records">
  <div class="form-row">
    <label for="node-input-name"><i class="icon-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name">
  </div>
  <div class="form-row">
    <label for="node-input-server"><i class="icon-db"></i> Server</label>
    <input type="text" id="node-input-server" placeholder="server">
  </div>
</script>


<!-- ****************************** Modify Record Node ****************************** -->

<script type="text/javascript">
  RED.nodes.registerType('modify record', {
    category: 'Service Now Table API',
    color: '#8fc1ba',
    defaults: {
      name: {
        value: ""
      },
      server: {
        value: "",
        type: "servicenow-config"
      }
    },
    inputs: 1,
    outputs: 1,
    icon: "nodered-contrib-servicenow-icon.png",
    label: function() {
      return this.name || "modify record";
    }
  });
</script>
  <script type="text/x-red" data-template-name="modify record">
  <div class="form-row">
    <label for="node-input-name"><i class="icon-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name">
  </div>
  <div class="form-row">
    <label for="node-input-server"><i class="icon-db"></i> Server</label>
    <input type="text" id="node-input-server" placeholder="server">
  </div>
</script>

<!-- ****************************** Patch Record Node ****************************** -->

<script type="text/javascript">
  RED.nodes.registerType('patch record', {
    category: 'Service Now Table API',
    color: '#8fc1ba',
    defaults: {
      name: {
        value: ""
      },
      server: {
        value: "",
        type: "servicenow-config"
      }
    },
    inputs: 1,
    outputs: 1,
    icon: "nodered-contrib-servicenow-icon.png",
    label: function() {
      return this.name || "patch record";
    }
  });
</script>
  <script type="text/x-red" data-template-name="patch record">
  <div class="form-row">
    <label for="node-input-name"><i class="icon-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name">
  </div>
  <div class="form-row">
    <label for="node-input-server"><i class="icon-db"></i> Server</label>
    <input type="text" id="node-input-server" placeholder="server">
  </div>
</script>

<!-- ****************************** Delete Record Node ****************************** -->

<script type="text/javascript">
  RED.nodes.registerType('delete record', {
    category: 'Service Now Table API',
    color: '#8fc1ba',
    defaults: {
      name: {
        value: ""
      },
      server: {
        value: "",
        type: "servicenow-config"
      }
    },
    inputs: 1,
    outputs: 1,
    icon: "nodered-contrib-servicenow-icon.png",
    label: function() {
      return this.name || "delete record";
    }
  });
</script>
  <script type="text/x-red" data-template-name="delete record">
  <div class="form-row">
    <label for="node-input-name"><i class="icon-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name">
  </div>
  <div class="form-row">
    <label for="node-input-server"><i class="icon-db"></i> Server</label>
    <input type="text" id="node-input-server" placeholder="server">
  </div>
</script>


<!-- ****************************** Get Attachment Metadata Node ****************************** -->

<script type="text/javascript">
  RED.nodes.registerType('get attachment metadata', {
    category: 'Service Now Attachment API',
    color: '#8fc1ba',
    defaults: {
      name: {
        value: ""
      },
      server: {
        value: "",
        type: "servicenow-config"
      }
    },
    inputs: 1,
    outputs: 1,
    icon: "nodered-contrib-servicenow-icon.png",
    label: function() {
      return this.name || "get attachment metadata";
    }
  });
</script>
  <script type="text/x-red" data-template-name="get attachment metadata">
  <div class="form-row">
    <label for="node-input-name"><i class="icon-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name">
  </div>
  <div class="form-row">
    <label for="node-input-server"><i class="icon-db"></i> Server</label>
    <input type="text" id="node-input-server" placeholder="server">
  </div>
</script>

<script type="text/x-red" data-help-name="get attachment metadata">
  <p>Retrieves metadata for ServiceNow attachments. Supports two modes:</p>
  <h3>Mode 1: Single Attachment</h3>
  <p>Retrieves metadata for a single attachment by sys_id.</p>
  <h4>Inputs</h4>
  <dl class="message-properties">
    <dt>sys_id <span class="property-type">string</span></dt>
    <dd>The sys_id of the attachment (required for single mode)</dd>
  </dl>
  <h4>Outputs</h4>
  <dl class="message-properties">
    <dt>payload <span class="property-type">object</span></dt>
    <dd>Single attachment metadata object</dd>
  </dl>
  <h4>Example</h4>
  <pre>msg.sys_id = "attachment_sys_id";</pre>

  <h3>Mode 2: Query-Based (Multiple Attachments)</h3>
  <p>Retrieves metadata for multiple attachments using a query. Useful for listing all attachments on a record.</p>
  <h4>Inputs</h4>
  <dl class="message-properties">
    <dt>sysparm_query <span class="property-type">string</span></dt>
    <dd>Encoded query to filter attachments (required for query mode). Example: "table_name=incident^table_sys_id=abc123"</dd>
    <dt class="optional">sysparm_limit <span class="property-type">number</span></dt>
    <dd>Maximum number of results (optional, default: 1000)</dd>
    <dt class="optional">sysparm_offset <span class="property-type">number</span></dt>
    <dd>Number of records to skip (optional, default: 0)</dd>
  </dl>
  <h4>Outputs</h4>
  <dl class="message-properties">
    <dt>payload <span class="property-type">array</span></dt>
    <dd>Array of attachment metadata objects</dd>
  </dl>
  <h4>Example</h4>
  <pre>// Get all attachments for a specific record
msg.sysparm_query = "table_name=incident^table_sys_id=" + recordSysId;
msg.sysparm_limit = 100; // optional
msg.sysparm_offset = 0;  // optional</pre>
</script>


<!-- ****************************** Delete Attachment Node ****************************** -->

<script type="text/javascript">
  RED.nodes.registerType('delete attachment', {
    category: 'Service Now Attachment API',
    color: '#8fc1ba',
    defaults: {
      name: {
        value: ""
      },
      server: {
        value: "",
        type: "servicenow-config"
      }
    },
    inputs: 1,
    outputs: 1,
    icon: "nodered-contrib-servicenow-icon.png",
    label: function() {
      return this.name || "delete attachment";
    }
  });
</script>
  <script type="text/x-red" data-template-name="delete attachment">
  <div class="form-row">
    <label for="node-input-name"><i class="icon-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name">
  </div>
  <div class="form-row">
    <label for="node-input-server"><i class="icon-db"></i> Server</label>
    <input type="text" id="node-input-server" placeholder="server">
  </div>
</script>

<script type="text/x-red" data-help-name="delete attachment">
  <p>Deletes a ServiceNow attachment.</p>
  <h3>Inputs</h3>
  <dl class="message-properties">
    <dt>sys_id <span class="property-type">string</span></dt>
    <dd>The sys_id of the attachment to delete (required)</dd>
  </dl>
  <h3>Outputs</h3>
  <dl class="message-properties">
    <dt>payload <span class="property-type">object</span></dt>
    <dd>Empty object on successful deletion</dd>
    <dt>statusCode <span class="property-type">number</span></dt>
    <dd>204 on success</dd>
  </dl>
</script>


<!-- ****************************** Upload Attachment Node ****************************** -->

<script type="text/javascript">
  RED.nodes.registerType('upload attachment', {
    category: 'Service Now Attachment API',
    color: '#8fc1ba',
    defaults: {
      name: {
        value: ""
      },
      server: {
        value: "",
        type: "servicenow-config"
      }
    },
    inputs: 1,
    outputs: 1,
    icon: "nodered-contrib-servicenow-icon.png",
    label: function() {
      return this.name || "upload attachment";
    }
  });
</script>
  <script type="text/x-red" data-template-name="upload attachment">
  <div class="form-row">
    <label for="node-input-name"><i class="icon-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name">
  </div>
  <div class="form-row">
    <label for="node-input-server"><i class="icon-db"></i> Server</label>
    <input type="text" id="node-input-server" placeholder="server">
  </div>
</script>

<script type="text/x-red" data-help-name="upload attachment">
  <p>Uploads a file as an attachment to a ServiceNow record.</p>
  <h3>Inputs</h3>
  <dl class="message-properties">
    <dt>topic <span class="property-type">string</span></dt>
    <dd>Table name (e.g., "incident", "problem") (required)</dd>
    <dt>sys_id <span class="property-type">string</span></dt>
    <dd>The sys_id of the record to attach the file to (required)</dd>
    <dt>filename <span class="property-type">string</span></dt>
    <dd>Name of the file (required)</dd>
    <dt>payload <span class="property-type">Buffer</span></dt>
    <dd>File content as Buffer (required)</dd>
    <dt class="optional">contentType <span class="property-type">string</span></dt>
    <dd>MIME type (optional, default: "application/octet-stream")</dd>
    <dt class="optional">encryption_context <span class="property-type">string</span></dt>
    <dd>Sys_id of an encryption context record to encrypt the file. Only users with the specified encryption context can access the attachment (optional)</dd>
    <dt class="optional">creation_time <span class="property-type">string</span></dt>
    <dd>Creation date and time of the attachment. Use this to capture attachment creation times when uploading from offline apps (optional, default: current date/time)</dd>
  </dl>
  <h3>Outputs</h3>
  <dl class="message-properties">
    <dt>payload <span class="property-type">object</span></dt>
    <dd>Attachment metadata of the uploaded file</dd>
  </dl>
  <h3>Example</h3>
  <pre>
msg.topic = "incident";
msg.sys_id = "abc123...";
msg.filename = "screenshot.jpg";
msg.payload = Buffer.from(...);
msg.contentType = "image/jpeg";
msg.encryption_context = "encryption_sys_id"; // optional
msg.creation_time = "2025-01-01 12:00:00"; // optional</pre>
</script>


<!-- ****************************** Download Attachment Node ****************************** -->

<script type="text/javascript">
  RED.nodes.registerType('download attachment', {
    category: 'Service Now Attachment API',
    color: '#8fc1ba',
    defaults: {
      name: {
        value: ""
      },
      server: {
        value: "",
        type: "servicenow-config"
      }
    },
    inputs: 1,
    outputs: 1,
    icon: "nodered-contrib-servicenow-icon.png",
    label: function() {
      return this.name || "download attachment";
    }
  });
</script>
  <script type="text/x-red" data-template-name="download attachment">
  <div class="form-row">
    <label for="node-input-name"><i class="icon-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name">
  </div>
  <div class="form-row">
    <label for="node-input-server"><i class="icon-db"></i> Server</label>
    <input type="text" id="node-input-server" placeholder="server">
  </div>
</script>

<script type="text/x-red" data-help-name="download attachment">
  <p>Downloads a file from ServiceNow attachments.</p>
  <h3>Inputs</h3>
  <dl class="message-properties">
    <dt>sys_id <span class="property-type">string</span></dt>
    <dd>The sys_id of the attachment to download (required)</dd>
  </dl>
  <h3>Outputs</h3>
  <dl class="message-properties">
    <dt>payload <span class="property-type">Buffer</span></dt>
    <dd>File content as Buffer</dd>
    <dt>filename <span class="property-type">string</span></dt>
    <dd>Original filename from ServiceNow</dd>
    <dt>contentType <span class="property-type">string</span></dt>
    <dd>MIME type of the file</dd>
  </dl>
  <h3>Details</h3>
  <p>This node first retrieves the attachment metadata (filename, content type), then downloads the file binary content.</p>
</script>


